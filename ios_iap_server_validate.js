
/* 苹果内购 服务端校验
 * powerd by  zlh 
 * 625335512@qq.com
 * ios iap 服务器端的验证代码

 * 1.接受客户端发来的凭证
 * 2.去apple验证 
 * 3.如果验证成功 然后给客户端方法道具
 * */



var https = require("https");


var req_hostname = "buy.itunes.apple.com" //真正购买用这个地址
var req_hostname = "sandbox.itunes.apple.com" //真正购买用这个地址
var reqSubPath = "/verifyReceipt"

	/*
	 * 下面的是客户端传给服务器（我们自己的）的字符串
	{
		"signature" = "AppNEG/IxUXhLvUHokhrOKhOmLfCOSTelq59ajpfnuEAgO8rl1daotd8jFgYhxd4eNMTp4M8Cpvggj/DfLPJLJR2tLGkarOjugKYhzhFO4XUkN7oiX8KIG+OSz1Ax9d1R9R/Y+6pj2qCYJKEUOc1COHWSRAMGDVX2qGlAmoB2KD2AAADVzCCA1MwggI7oAMCAQICCBup4+PAhm/LMA0GCSqGSIb3DQEBBQUAMH8xCzAJBgNVBAYTAlVTMRMwEQYDVQQKDApBcHBsZSBJbmMuMSYwJAYDVQQLDB1BcHBsZSBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eTEzMDEGA1UEAwwqQXBwbGUgaVR1bmVzIFN0b3JlIENlcnRpZmljYXRpb24gQXV0aG9yaXR5MB4XDTE0MDYwNzAwMDIyMVoXDTE2MDUxODE4MzEzMFowZDEjMCEGA1UEAwwaUHVyY2hhc2VSZWNlaXB0Q2VydGlmaWNhdGUxGzAZBgNVBAsMEkFwcGxlIGlUdW5lcyBTdG9yZTETMBEGA1UECgwKQXBwbGUgSW5jLjELMAkGA1UEBhMCVVMwgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAMmTEuLgjimLwRJxy1oEf0esUNDVEIe6wDsnnal14hNBt1v195X6n93YO7gi3orPSux9D554SkMp+Sayg84lTc362UtmYLpWnb34nqyGx9KBVTy5OGV4ljE1OwC+oTnRM+QLRCmeNxMbPZhS47T+eZtDEhVB9usk3+JM2Cogfwo7AgMBAAGjcjBwMB0GA1UdDgQWBBSJaEeNuq9Df6ZfN68Fe+I2u22ssDAMBgNVHRMBAf8EAjAAMB8GA1UdIwQYMBaAFDYd6OKdgtIBGLUyaw7XQwuRWEM6MA4GA1UdDwEB/wQEAwIHgDAQBgoqhkiG92NkBgUBBAIFADANBgkqhkiG9w0BAQUFAAOCAQEAeaJV2U51rxfcqAAe5C2/fEW8KUl4iO4lMuta7N6XzP1pZIz1NkkCtIIweyNj5URYHK+HjRKSU9RLguNl0nkfxqObiMckwRudKSq69NInrZyCD66R4K77nb9lMTABSSYlsKt8oNtlhgR/1kjSSRQcHktsDcSiQGKMdkSlp4AyXf7vnHPBe4yCwYV2PpSN04kboiJ3pBlxsGwV/ZlL26M2ueYHKYCuXhdqFwxVgm52h3oeJOOt/vY4EcQq7eqHm6m03Z9b7PRzYM2KGXHDmOMk7vDpeMVlLDPSGYz1+U3sDxJzebSpbaJmT7imzUKfggEY7xxf4czfH0yj5wNzSGTOvQ==";
		"purchase-info" = "ewoJIm9yaWdpbmFsLXB1cmNoYXNlLWRhdGUtcHN0IiA9ICIyMDE1LTA1LTIxIDIyOjE5OjE0IEFtZXJpY2EvTG9zX0FuZ2VsZXMiOwoJInVuaXF1ZS1pZGVudGlmaWVyIiA9ICI1MzNjMDBiNWE5Zjc4YWIyYWVmNDQ4NDlmZmQ2ZDIzYTNhZTVhMzlmIjsKCSJvcmlnaW5hbC10cmFuc2FjdGlvbi1pZCIgPSAiMTAwMDAwMDE1NjI2MzQ3OCI7CgkiYnZycyIgPSAiMS4wIjsKCSJ0cmFuc2FjdGlvbi1pZCIgPSAiMTAwMDAwMDE1NjI2MzQ3OCI7CgkicXVhbnRpdHkiID0gIjEiOwoJIm9yaWdpbmFsLXB1cmNoYXNlLWRhdGUtbXMiID0gIjE0MzIyNzE5NTQ1NDIiOwoJInVuaXF1ZS12ZW5kb3ItaWRlbnRpZmllciIgPSAiODk5OTFBREUtRjNCRC00QkQyLUEyOEEtRkU3MzU3MzE0NEEyIjsKCSJwcm9kdWN0LWlkIiA9ICJpZF96dWFuc2hpXzFfIjsKCSJpdGVtLWlkIiA9ICI5OTU5MjEzMzkiOwoJImJpZCIgPSAiY29tLndpbmdvZmdvZC53aW5nb2Znb2QiOwoJInB1cmNoYXNlLWRhdGUtbXMiID0gIjE0MzIyNzE5NTQ1NDIiOwoJInB1cmNoYXNlLWRhdGUiID0gIjIwMTUtMDUtMjIgMDU6MTk6MTQgRXRjL0dNVCI7CgkicHVyY2hhc2UtZGF0ZS1wc3QiID0gIjIwMTUtMDUtMjEgMjI6MTk6MTQgQW1lcmljYS9Mb3NfQW5nZWxlcyI7Cgkib3JpZ2luYWwtcHVyY2hhc2UtZGF0ZSIgPSAiMjAxNS0wNS0yMiAwNToxOToxNCBFdGMvR01UIjsKfQ==";
		"environment" = "Sandbox";
		"pod" = "100";
		"signing-status" = "0";
	}
	*/
	
	//  requestDataObj["receipt-data"] 是 上面的字符串经过base64 编码的字符串   可以直接用这个字符串进行测试
var requestDataObj = {"receipt-data":"ewoJInNpZ25hdHVyZSIgPSAiQXBwTkVHL0l4VVhoTHZVSG9raHJPS2hPbUxmQ09TVGVscTU5YWpwZm51RUFnTzhybDFkYW90ZDhqRmdZaHhkNGVOTVRwNE04Q3B2Z2dqL0RmTFBKTEpSMnRMR2thck9qdWdLWWh6aEZPNFhVa043b2lYOEtJRytPU3oxQXg5ZDFSOVIvWSs2cGoycUNZSktFVU9jMUNPSFdTUkFNR0RWWDJxR2xBbW9CMktEMkFBQURWekNDQTFNd2dnSTdvQU1DQVFJQ0NCdXA0K1BBaG0vTE1BMEdDU3FHU0liM0RRRUJCUVVBTUg4eEN6QUpCZ05WQkFZVEFsVlRNUk13RVFZRFZRUUtEQXBCY0hCc1pTQkpibU11TVNZd0pBWURWUVFMREIxQmNIQnNaU0JEWlhKMGFXWnBZMkYwYVc5dUlFRjFkR2h2Y21sMGVURXpNREVHQTFVRUF3d3FRWEJ3YkdVZ2FWUjFibVZ6SUZOMGIzSmxJRU5sY25ScFptbGpZWFJwYjI0Z1FYVjBhRzl5YVhSNU1CNFhEVEUwTURZd056QXdNREl5TVZvWERURTJNRFV4T0RFNE16RXpNRm93WkRFak1DRUdBMVVFQXd3YVVIVnlZMmhoYzJWU1pXTmxhWEIwUTJWeWRHbG1hV05oZEdVeEd6QVpCZ05WQkFzTUVrRndjR3hsSUdsVWRXNWxjeUJUZEc5eVpURVRNQkVHQTFVRUNnd0tRWEJ3YkdVZ1NXNWpMakVMTUFrR0ExVUVCaE1DVlZNd2daOHdEUVlKS29aSWh2Y05BUUVCQlFBRGdZMEFNSUdKQW9HQkFNbVRFdUxnamltTHdSSnh5MW9FZjBlc1VORFZFSWU2d0Rzbm5hbDE0aE5CdDF2MTk1WDZuOTNZTzdnaTNvclBTdXg5RDU1NFNrTXArU2F5Zzg0bFRjMzYyVXRtWUxwV25iMzRucXlHeDlLQlZUeTVPR1Y0bGpFMU93QytvVG5STStRTFJDbWVOeE1iUFpoUzQ3VCtlWnRERWhWQjl1c2szK0pNMkNvZ2Z3bzdBZ01CQUFHamNqQndNQjBHQTFVZERnUVdCQlNKYUVlTnVxOURmNlpmTjY4RmUrSTJ1MjJzc0RBTUJnTlZIUk1CQWY4RUFqQUFNQjhHQTFVZEl3UVlNQmFBRkRZZDZPS2RndElCR0xVeWF3N1hRd3VSV0VNNk1BNEdBMVVkRHdFQi93UUVBd0lIZ0RBUUJnb3Foa2lHOTJOa0JnVUJCQUlGQURBTkJna3Foa2lHOXcwQkFRVUZBQU9DQVFFQWVhSlYyVTUxcnhmY3FBQWU1QzIvZkVXOEtVbDRpTzRsTXV0YTdONlh6UDFwWkl6MU5ra0N0SUl3ZXlOajVVUllISytIalJLU1U5UkxndU5sMG5rZnhxT2JpTWNrd1J1ZEtTcTY5Tkluclp5Q0Q2NlI0Szc3bmI5bE1UQUJTU1lsc0t0OG9OdGxoZ1IvMWtqU1NSUWNIa3RzRGNTaVFHS01ka1NscDRBeVhmN3ZuSFBCZTR5Q3dZVjJQcFNOMDRrYm9pSjNwQmx4c0d3Vi9abEwyNk0ydWVZSEtZQ3VYaGRxRnd4VmdtNTJoM29lSk9PdC92WTRFY1FxN2VxSG02bTAzWjliN1BSellNMktHWEhEbU9Nazd2RHBlTVZsTERQU0dZejErVTNzRHhKemViU3BiYUptVDdpbXpVS2ZnZ0VZN3h4ZjRjemZIMHlqNXdOelNHVE92UT09IjsKCSJwdXJjaGFzZS1pbmZvIiA9ICJld29KSW05eWFXZHBibUZzTFhCMWNtTm9ZWE5sTFdSaGRHVXRjSE4wSWlBOUlDSXlNREUxTFRBMUxUSXhJREl5T2pFNU9qRTBJRUZ0WlhKcFkyRXZURzl6WDBGdVoyVnNaWE1pT3dvSkluVnVhWEYxWlMxcFpHVnVkR2xtYVdWeUlpQTlJQ0kxTXpOak1EQmlOV0U1WmpjNFlXSXlZV1ZtTkRRNE5EbG1abVEyWkRJellUTmhaVFZoTXpsbUlqc0tDU0p2Y21sbmFXNWhiQzEwY21GdWMyRmpkR2x2YmkxcFpDSWdQU0FpTVRBd01EQXdNREUxTmpJMk16UTNPQ0k3Q2draVluWnljeUlnUFNBaU1TNHdJanNLQ1NKMGNtRnVjMkZqZEdsdmJpMXBaQ0lnUFNBaU1UQXdNREF3TURFMU5qSTJNelEzT0NJN0Nna2ljWFZoYm5ScGRIa2lJRDBnSWpFaU93b0pJbTl5YVdkcGJtRnNMWEIxY21Ob1lYTmxMV1JoZEdVdGJYTWlJRDBnSWpFME16SXlOekU1TlRRMU5ESWlPd29KSW5WdWFYRjFaUzEyWlc1a2IzSXRhV1JsYm5ScFptbGxjaUlnUFNBaU9EazVPVEZCUkVVdFJqTkNSQzAwUWtReUxVRXlPRUV0UmtVM016VTNNekUwTkVFeUlqc0tDU0p3Y205a2RXTjBMV2xrSWlBOUlDSnBaRjk2ZFdGdWMyaHBYekZmSWpzS0NTSnBkR1Z0TFdsa0lpQTlJQ0k1T1RVNU1qRXpNemtpT3dvSkltSnBaQ0lnUFNBaVkyOXRMbmRwYm1kdlptZHZaQzUzYVc1bmIyWm5iMlFpT3dvSkluQjFjbU5vWVhObExXUmhkR1V0YlhNaUlEMGdJakUwTXpJeU56RTVOVFExTkRJaU93b0pJbkIxY21Ob1lYTmxMV1JoZEdVaUlEMGdJakl3TVRVdE1EVXRNaklnTURVNk1UazZNVFFnUlhSakwwZE5WQ0k3Q2draWNIVnlZMmhoYzJVdFpHRjBaUzF3YzNRaUlEMGdJakl3TVRVdE1EVXRNakVnTWpJNk1UazZNVFFnUVcxbGNtbGpZUzlNYjNOZlFXNW5aV3hsY3lJN0Nna2liM0pwWjJsdVlXd3RjSFZ5WTJoaGMyVXRaR0YwWlNJZ1BTQWlNakF4TlMwd05TMHlNaUF3TlRveE9Ub3hOQ0JGZEdNdlIwMVVJanNLZlE9PSI7CgkiZW52aXJvbm1lbnQiID0gIlNhbmRib3giOwoJInBvZCIgPSAiMTAwIjsKCSJzaWduaW5nLXN0YXR1cyIgPSAiMCI7Cn0="}

//下面是 对应的apple 服务器返回的json 数据 status=0 表示成功
var responsedataObj = {
	"receipt" : {
		"original_purchase_date_pst" : "2015-05-21 22:19:14 America/Los_Angeles",
		"purchase_date_ms" : "1432271954542",
		"unique_identifier" : "533c00b5a9f78ab2aef44849ffd6d23a3ae5a39f",
		"original_transaction_id" : "1000000156263478",
		"bvrs" : "1.0",
		"transaction_id" : "1000000156263478",
		"quantity" : "1",
		"unique_vendor_identifier" : "89991ADE-F3BD-4BD2-A28A-FE73573144A2",
		"item_id" : "995921339",
		"product_id" : "id_zuanshi_1_",
		"purchase_date" : "2015-05-22 05:19:14 Etc/GMT",
		"original_purchase_date" : "2015-05-22 05:19:14 Etc/GMT",
		"purchase_date_pst" : "2015-05-21 22:19:14America/Los_Angeles",
		"bid" : "com.wingofgod.wingofgod",
		"original_purchase_date_ms" : "1432271954542"
	},
	"status" : 0
}

function main() {
	var options = { 
			hostname: req_hostname
				, path: reqSubPath
				, method: "POST"
			};//请求的参数设置
	
	var req = https.request(options, function (response) {
										//response 对象是 收到恢复后的 对象
		var str = "data=";
		response.on("data", function (data) {//收到数据的回调函数
			str = str + data;
		});
		response.on("end", function () {//响应 结束的回调函数
			console.log(str);
		});
	});
	
	req.on("error", function (e) {//请求出错的回调
		console.log('problem with request: ' + e.message);
	});
	
	var jsondata = JSON.stringify(requestDataObj);//发送的是一个json 字符串
	req.write(jsondata);
	req.end();//发出请求

	
}





main();

